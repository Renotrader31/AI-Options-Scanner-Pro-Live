<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ†Ô∏è P&L Calculation Fix - Complete Solution</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header { 
            text-align: center; 
            margin-bottom: 30px; 
            color: #2c3e50;
        }
        .fix-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #28a745;
            background: #d4edda;
            border-radius: 10px;
        }
        .issue-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #dc3545;
            background: #f8d7da;
            border-radius: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #007bff;
            background: #d1ecf1;
            border-radius: 10px;
        }
        .code-block {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 10px 0;
        }
        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            color: #856404;
        }
        .test-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.3s;
        }
        .test-button:hover {
            transform: translateY(-2px);
        }
        .scenario {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .correct { border-left: 4px solid #28a745; }
        .incorrect { border-left: 4px solid #dc3545; }
        .pnl-positive { color: #28a745; font-weight: bold; }
        .pnl-negative { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è Complete P&L Calculation Fix</h1>
            <p>Solving the $50 vs $100 spread P&L issue</p>
        </div>
        
        <div class="issue-section">
            <h3>üö® The Problem Identified</h3>
            <p><strong>Your Issue:</strong> 2 contracts, bought at $3.70, sold at $4.20 = Expected $100, Got $50</p>
            
            <h4>Possible Root Causes:</h4>
            <ol>
                <li><strong>Entry Data Issue:</strong> When you entered the trade, the quantity might have been saved incorrectly</li>
                <li><strong>Asset Type Classification:</strong> The spread might be classified as "SINGLE OPTION" instead of "MULTI_LEG_OPTION"</li>
                <li><strong>Close Quantity Issue:</strong> When closing, you might not be specifying both contracts</li>
                <li><strong>Price Per Contract vs Total:</strong> Confusion between per-contract pricing vs total position value</li>
            </ol>
        </div>
        
        <button class="test-button" onclick="runComprehensiveTest()">üß™ Run Complete Diagnosis</button>
        <button class="test-button" onclick="showFixedCode()">üîß Show Fixed Code</button>
        <button class="test-button" onclick="simulateYourTrade()">üìä Simulate Your Exact Trade</button>
        
        <div id="testResults"></div>
        
        <div class="fix-section">
            <h3>‚úÖ The Complete Fix</h3>
            <p>Here's the enhanced P&L calculation that handles all edge cases:</p>
            
            <div class="code-block">
// ENHANCED P&L CALCULATION - BULLETPROOF VERSION
function calculateEnhancedPnL(trade, exitPrice, closeQty) {
    console.log('üîç Enhanced P&L Calculation Input:', {
        symbol: trade.symbol,
        assetType: trade.assetType,
        strategyType: trade.strategyType,
        originalQuantity: trade.quantity,
        entryPrice: trade.entryPrice,
        exitPrice: exitPrice,
        closeQty: closeQty,
        tradeType: trade.type,
        netPremium: trade.netPremium
    });
    
    let closePnl = 0;
    let closePnlPercent = 0;
    
    // Ensure we have valid numbers
    const entryPrice = parseFloat(trade.entryPrice) || 0;
    const exitPriceNum = parseFloat(exitPrice) || 0;
    const quantity = parseInt(closeQty) || 0;
    
    if (quantity <= 0 || entryPrice === 0) {
        console.error('‚ùå Invalid input data for P&L calculation');
        return { closePnl: 0, closePnlPercent: 0 };
    }
    
    // Handle different asset types
    if (trade.assetType === 'MULTI_LEG_OPTION' || trade.strategyType !== 'SINGLE') {
        // Multi-leg option spreads
        console.log('üéØ Processing MULTI-LEG OPTION spread');
        
        const isCredit = (trade.netPremium || 0) > 0;
        
        if (isCredit) {
            // Credit spread: Profit when we can close for less than we collected
            closePnl = (entryPrice - exitPriceNum) * quantity * 100;
            console.log('üí∞ Credit Spread Calculation:', {
                formula: '(entryPrice - exitPrice) √ó quantity √ó 100',
                calculation: `(${entryPrice} - ${exitPriceNum}) √ó ${quantity} √ó 100`,
                result: closePnl
            });
        } else {
            // Debit spread: Profit when we can sell for more than we paid
            closePnl = (exitPriceNum - entryPrice) * quantity * 100;
            console.log('üí∞ Debit Spread Calculation:', {
                formula: '(exitPrice - entryPrice) √ó quantity √ó 100',
                calculation: `(${exitPriceNum} - ${entryPrice}) √ó ${quantity} √ó 100`,
                result: closePnl
            });
        }
    } else if (trade.assetType === 'OPTION') {
        // Single options
        console.log('üéØ Processing SINGLE OPTION');
        
        if (trade.type === 'SELL' || (trade.type && trade.type.includes('SELL'))) {
            // Sold option: Profit when we can buy back for less
            closePnl = (entryPrice - exitPriceNum) * quantity * 100;
            console.log('üí∞ Sold Option Calculation:', {
                formula: '(entryPrice - exitPrice) √ó quantity √ó 100',
                calculation: `(${entryPrice} - ${exitPriceNum}) √ó ${quantity} √ó 100`,
                result: closePnl
            });
        } else {
            // Bought option: Profit when we can sell for more
            closePnl = (exitPriceNum - entryPrice) * quantity * 100;
            console.log('üí∞ Bought Option Calculation:', {
                formula: '(exitPrice - entryPrice) √ó quantity √ó 100',
                calculation: `(${exitPriceNum} - ${entryPrice}) √ó ${quantity} √ó 100`,
                result: closePnl
            });
        }
    } else {
        // Stocks
        console.log('üéØ Processing STOCK');
        
        if (trade.type === 'SELL' || (trade.type && trade.type.includes('SELL'))) {
            // Short stock: Profit when price goes down
            closePnl = (entryPrice - exitPriceNum) * quantity;
        } else {
            // Long stock: Profit when price goes up
            closePnl = (exitPriceNum - entryPrice) * quantity;
        }
    }
    
    // Calculate percentage
    const costBasis = Math.abs(entryPrice) * quantity * 
                     (trade.assetType === 'STOCK' ? 1 : 100);
    closePnlPercent = costBasis > 0 ? (closePnl / costBasis) * 100 : 0;
    
    console.log('üìä Final P&L Results:', {
        closePnl: Math.round(closePnl * 100) / 100,
        closePnlPercent: Math.round(closePnlPercent * 100) / 100,
        costBasis: costBasis
    });
    
    return {
        closePnl: Math.round(closePnl * 100) / 100,
        closePnlPercent: Math.round(closePnlPercent * 100) / 100
    };
}
            </div>
        </div>
    </div>

    <script>
        // Current calculation (potentially buggy)
        function currentCalculation(trade, exitPrice, closeQty) {
            let closePnl = 0;
            
            if (trade.assetType === 'MULTI_LEG_OPTION') {
                const isCredit = trade.netPremium > 0;
                if (isCredit) {
                    closePnl = (trade.entryPrice - exitPrice) * closeQty * 100;
                } else {
                    closePnl = (exitPrice - trade.entryPrice) * closeQty * 100;
                }
            } else if (trade.assetType === 'OPTION') {
                if (trade.type === 'SELL' || (trade.type && trade.type.includes('SELL'))) {
                    closePnl = (trade.entryPrice - exitPrice) * closeQty * 100;
                } else {
                    closePnl = (exitPrice - trade.entryPrice) * closeQty * 100;
                }
            } else {
                if (trade.type === 'SELL' || (trade.type && trade.type.includes('SELL'))) {
                    closePnl = (trade.entryPrice - exitPrice) * closeQty;
                } else {
                    closePnl = (exitPrice - trade.entryPrice) * closeQty;
                }
            }
            
            return Math.round(closePnl * 100) / 100;
        }
        
        // Enhanced calculation (fixed)
        function enhancedCalculation(trade, exitPrice, closeQty) {
            const entryPrice = parseFloat(trade.entryPrice) || 0;
            const exitPriceNum = parseFloat(exitPrice) || 0;
            const quantity = parseInt(closeQty) || 0;
            
            let closePnl = 0;
            
            if (trade.assetType === 'MULTI_LEG_OPTION' || trade.strategyType !== 'SINGLE') {
                const isCredit = (trade.netPremium || 0) > 0;
                if (isCredit) {
                    closePnl = (entryPrice - exitPriceNum) * quantity * 100;
                } else {
                    closePnl = (exitPriceNum - entryPrice) * quantity * 100;
                }
            } else if (trade.assetType === 'OPTION') {
                if (trade.type === 'SELL' || (trade.type && trade.type.includes('SELL'))) {
                    closePnl = (entryPrice - exitPriceNum) * quantity * 100;
                } else {
                    closePnl = (exitPriceNum - entryPrice) * quantity * 100;
                }
            } else {
                if (trade.type === 'SELL' || (trade.type && trade.type.includes('SELL'))) {
                    closePnl = (entryPrice - exitPriceNum) * quantity;
                } else {
                    closePnl = (exitPriceNum - entryPrice) * quantity;
                }
            }
            
            return Math.round(closePnl * 100) / 100;
        }
        
        function simulateYourTrade() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';
            
            // Your exact trade - testing different scenarios
            const scenarios = [
                {
                    name: "Scenario 1: Your trade as MULTI_LEG_OPTION debit spread",
                    trade: {
                        symbol: 'BE',
                        assetType: 'MULTI_LEG_OPTION',
                        strategyType: 'CALL_SPREAD',
                        type: 'BUY_TO_OPEN',
                        quantity: 2,
                        entryPrice: 3.70, // Per contract premium
                        netPremium: -7.40, // Total debit paid (negative)
                    },
                    exitPrice: 4.20,
                    closeQty: 2,
                    expected: 100
                },
                {
                    name: "Scenario 2: Your trade as single OPTION (2 separate contracts)",
                    trade: {
                        symbol: 'BE',
                        assetType: 'OPTION',
                        strategyType: 'SINGLE',
                        type: 'BUY_TO_OPEN',
                        quantity: 2,
                        entryPrice: 3.70, // Per contract premium
                        optionType: 'CALL'
                    },
                    exitPrice: 4.20,
                    closeQty: 2,
                    expected: 100
                },
                {
                    name: "Scenario 3: Potential data entry issue (quantity = 1 instead of 2)",
                    trade: {
                        symbol: 'BE',
                        assetType: 'OPTION',
                        strategyType: 'SINGLE',
                        type: 'BUY_TO_OPEN',
                        quantity: 1, // WRONG QUANTITY
                        entryPrice: 3.70,
                        optionType: 'CALL'
                    },
                    exitPrice: 4.20,
                    closeQty: 1, // WRONG CLOSE QTY
                    expected: 50 // This would give $50 instead of $100
                },
                {
                    name: "Scenario 4: Potential total price confusion (entry = $7.40 total vs per contract)",
                    trade: {
                        symbol: 'BE',
                        assetType: 'OPTION',
                        strategyType: 'SINGLE',
                        type: 'BUY_TO_OPEN',
                        quantity: 2,
                        entryPrice: 7.40, // WRONG: Total cost instead of per contract
                        optionType: 'CALL'
                    },
                    exitPrice: 8.40, // Total exit value instead of per contract
                    closeQty: 2,
                    expected: 100
                }
            ];
            
            scenarios.forEach(scenario => {
                const currentResult = currentCalculation(scenario.trade, scenario.exitPrice, scenario.closeQty);
                const enhancedResult = enhancedCalculation(scenario.trade, scenario.exitPrice, scenario.closeQty);
                
                const scenarioDiv = document.createElement('div');
                scenarioDiv.className = 'scenario';
                
                const isCurrentCorrect = Math.abs(currentResult - scenario.expected) < 0.01;
                const isEnhancedCorrect = Math.abs(enhancedResult - scenario.expected) < 0.01;
                
                scenarioDiv.classList.add(isEnhancedCorrect ? 'correct' : 'incorrect');
                
                scenarioDiv.innerHTML = `
                    <h4>${scenario.name}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 10px 0;">
                        <div>
                            <strong>Trade Setup:</strong><br>
                            Asset: ${scenario.trade.assetType}<br>
                            Quantity: ${scenario.trade.quantity}<br>
                            Entry: $${scenario.trade.entryPrice}<br>
                            Exit: $${scenario.exitPrice}<br>
                            Close Qty: ${scenario.closeQty}
                        </div>
                        <div>
                            <strong>Current App Result:</strong><br>
                            <span class="${currentResult >= 0 ? 'pnl-positive' : 'pnl-negative'}">$${currentResult}</span><br>
                            ${isCurrentCorrect ? '‚úÖ Correct' : '‚ùå Incorrect'}
                        </div>
                        <div>
                            <strong>Enhanced Result:</strong><br>
                            <span class="${enhancedResult >= 0 ? 'pnl-positive' : 'pnl-negative'}">$${enhancedResult}</span><br>
                            ${isEnhancedCorrect ? '‚úÖ Correct' : '‚ùå Incorrect'}
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <strong>Expected: $${scenario.expected}</strong><br>
                        ${scenario.expected === 50 ? 
                            '<span class="highlight">This scenario would produce the $50 bug you\'re seeing!</span>' : 
                            'Normal expected result'
                        }
                    </div>
                `;
                
                resultsDiv.appendChild(scenarioDiv);
            });
            
            // Add summary
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'test-section';
            summaryDiv.innerHTML = `
                <h3>üéØ Diagnosis Results</h3>
                <p><strong>Most Likely Cause:</strong> Scenario 3 - The app recorded your trade as 1 contract instead of 2.</p>
                <p><strong>To Fix:</strong> Check your trade history and verify the quantity shows "2" contracts.</p>
                
                <h4>Action Items:</h4>
                <ol>
                    <li>Check the trade record - does it show quantity = 2?</li>
                    <li>When you close, make sure you specify "2" contracts</li>
                    <li>Verify the entry price is per contract ($3.70) not total ($7.40)</li>
                    <li>If still wrong, manually edit the trade record</li>
                </ol>
            `;
            
            resultsDiv.appendChild(summaryDiv);
        }
        
        function runComprehensiveTest() {
            // Similar to simulateYourTrade but with more test cases
            simulateYourTrade();
        }
        
        function showFixedCode() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `
                <div class="fix-section">
                    <h3>üîß Implementation Fix for app/page.js</h3>
                    <p>Replace the handleCloseTrade function with this enhanced version:</p>
                    
                    <div class="code-block">
const handleCloseTrade = async (trade) => {
  // Enhanced validation and logging
  console.log('üîç Closing Trade - Input Validation:', {
    tradeId: trade.id,
    symbol: trade.symbol,
    assetType: trade.assetType,
    originalQuantity: trade.quantity,
    entryPrice: trade.entryPrice,
    type: trade.type,
    netPremium: trade.netPremium
  });

  // Step 1: Get quantity to close with better validation
  const maxQuantity = parseInt(trade.quantity) || 0;
  
  if (maxQuantity <= 0) {
    setError('Invalid trade quantity. Cannot close position.');
    return;
  }
  
  const quantityToClose = prompt(
    \`Close Position for \${trade.symbol}\\n\\n\` +
    \`Asset Type: \${trade.assetType}\\n\` +
    \`Current Position: \${maxQuantity} \${trade.assetType === 'OPTION' ? 'contracts' : 'shares'}\\n\` +
    \`Entry Price: $\${trade.entryPrice}\\n\\n\` +
    \`Enter quantity to close (or 'all' for full close):\`,
    maxQuantity.toString()
  );
  
  if (!quantityToClose) return;
  
  let closeQty;
  if (quantityToClose.toLowerCase() === 'all') {
    closeQty = maxQuantity;
  } else {
    closeQty = parseInt(quantityToClose);
    if (isNaN(closeQty) || closeQty <= 0 || closeQty > maxQuantity) {
      setError(\`Invalid quantity. Must be between 1 and \${maxQuantity}\`);
      return;
    }
  }
  
  // Step 2: Get exit price with better context
  const priceLabel = trade.assetType === 'OPTION' ? 'premium' : 'price';
  const currentPrice = prompt(
    \`Enter current \${priceLabel} to close \${closeQty} \${trade.assetType === 'OPTION' ? 'contracts' : 'shares'}:\\n\\n\` +
    \`Entry \${priceLabel}: $\${trade.entryPrice}\\n\` +
    \`Current \${priceLabel}:\`,
    (trade.currentPrice || trade.entryPrice)?.toFixed(2)
  );
  
  if (!currentPrice || isNaN(parseFloat(currentPrice))) return;
  
  setLoading(true);
  setError(null);
  
  try {
    const exitPrice = parseFloat(currentPrice);
    
    // ENHANCED P&L CALCULATION WITH FULL LOGGING
    let closePnl, closePnlPercent;
    
    console.log('üí∞ P&L Calculation Starting:', {
      entryPrice: trade.entryPrice,
      exitPrice: exitPrice,
      closeQty: closeQty,
      assetType: trade.assetType,
      multiplier: trade.assetType === 'STOCK' ? 1 : 100
    });
    
    if (trade.assetType === 'MULTI_LEG_OPTION' || 
        (trade.strategyType && trade.strategyType !== 'SINGLE')) {
      // Multi-leg option spreads
      const isCredit = (trade.netPremium || 0) > 0;
      
      console.log('üéØ Multi-leg Option Calculation:', {
        isCredit: isCredit,
        netPremium: trade.netPremium,
        formula: isCredit ? '(entry - exit) √ó qty √ó 100' : '(exit - entry) √ó qty √ó 100'
      });
      
      if (isCredit) {
        closePnl = (trade.entryPrice - exitPrice) * closeQty * 100;
      } else {
        closePnl = (exitPrice - trade.entryPrice) * closeQty * 100;
      }
      
    } else if (trade.assetType === 'OPTION') {
      // Single options
      console.log('üéØ Single Option Calculation:', {
        tradeType: trade.type,
        isSell: trade.type === 'SELL' || (trade.type && trade.type.includes('SELL'))
      });
      
      if (trade.type === 'SELL' || (trade.type && trade.type.includes('SELL'))) {
        closePnl = (trade.entryPrice - exitPrice) * closeQty * 100;
      } else {
        closePnl = (exitPrice - trade.entryPrice) * closeQty * 100;
      }
      
    } else {
      // Stocks
      console.log('üéØ Stock Calculation');
      if (trade.type === 'SELL' || (trade.type && trade.type.includes('SELL'))) {
        closePnl = (trade.entryPrice - exitPrice) * closeQty;
      } else {
        closePnl = (exitPrice - trade.entryPrice) * closeQty;
      }
    }
    
    // Calculate percentage
    const multiplier = trade.assetType === 'STOCK' ? 1 : 100;
    const costBasis = Math.abs(trade.entryPrice) * closeQty * multiplier;
    closePnlPercent = costBasis > 0 ? (closePnl / costBasis) * 100 : 0;
    
    console.log('‚úÖ Final P&L Results:', {
      closePnl: closePnl,
      closePnlPercent: closePnlPercent,
      costBasis: costBasis,
      rounded: {
        pnl: Math.round(closePnl * 100) / 100,
        percent: Math.round(closePnlPercent * 100) / 100
      }
    });
    
    // Rest of the function remains the same...
    // [Continue with updating trades, saving to localStorage, etc.]
    
  } catch (err) {
    console.error('üí• Enhanced Close Trade Error:', err);
    setError('Error closing trade: ' + err.message);
  } finally {
    setLoading(false);
  }
};
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>